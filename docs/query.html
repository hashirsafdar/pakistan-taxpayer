<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Query Pakistan Taxpayer Data - Interactive SQL</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, sans-serif;
                line-height: 1.6;
                color: #333;
                background: #f5f5f5;
            }

            header {
                background: linear-gradient(135deg, #0f4c81 0%, #1a6ba8 100%);
                color: white;
                padding: 2rem;
                text-align: center;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            header h1 {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }

            header p {
                opacity: 0.9;
            }

            .container {
                max-width: 1600px;
                margin: 2rem auto;
                padding: 0 1rem;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }

            .left-panel {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .right-panel {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                position: sticky;
                top: 1rem;
                align-self: start;
            }

            @media (max-width: 1024px) {
                .container {
                    grid-template-columns: 1fr;
                }

                .right-panel {
                    position: static;
                }
            }

            .query-box {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 1rem;
            }

            .query-box h2 {
                color: #0f4c81;
                margin-bottom: 1rem;
            }

            textarea {
                width: 100%;
                min-height: 120px;
                padding: 1rem;
                border: 2px solid #ddd;
                border-radius: 4px;
                font-family: "Courier New", monospace;
                font-size: 14px;
                resize: vertical;
            }

            textarea:focus {
                outline: none;
                border-color: #0f4c81;
            }

            .button-group {
                margin-top: 1rem;
                display: flex;
                gap: 1rem;
                align-items: center;
            }

            button {
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: 4px;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s;
            }

            button.primary {
                background: #0f4c81;
                color: white;
            }

            button.primary:hover {
                background: #1a6ba8;
            }

            button.secondary {
                background: #e0e0e0;
                color: #333;
            }

            button.secondary:hover {
                background: #d0d0d0;
            }

            .examples {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 1rem;
            }

            .examples h3 {
                color: #0f4c81;
                margin-bottom: 1rem;
            }

            .example-query {
                background: #f5f5f5;
                padding: 0.75rem;
                border-radius: 4px;
                margin-bottom: 0.5rem;
                font-family: "Courier New", monospace;
                font-size: 13px;
                cursor: pointer;
                border: 1px solid transparent;
            }

            .example-query:hover {
                background: #e8f4f8;
                border-color: #0f4c81;
            }

            .results {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                min-height: 400px;
            }

            .results h3 {
                color: #0f4c81;
                margin-bottom: 1rem;
            }

            .results-info {
                color: #666;
                margin-bottom: 1rem;
                font-size: 0.9rem;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                overflow-x: auto;
                display: block;
            }

            thead {
                background: #0f4c81;
                color: white;
            }

            th,
            td {
                padding: 0.75rem;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            tbody tr:hover {
                background: #f9f9f9;
            }

            .loading {
                text-align: center;
                padding: 2rem;
                color: #666;
            }

            .error {
                background: #fee;
                color: #c00;
                padding: 1rem;
                border-radius: 4px;
                margin-top: 1rem;
            }

            .status {
                padding: 0.5rem 1rem;
                border-radius: 4px;
                display: inline-block;
            }

            .status.loading {
                background: #fff3cd;
                color: #856404;
            }

            .status.ready {
                background: #d4edda;
                color: #155724;
            }

            .file-selector {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 1rem;
            }

            .file-selector h3 {
                color: #0f4c81;
                margin-bottom: 1rem;
            }

            .file-options {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .file-option {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem;
                border: 2px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .file-option:hover {
                border-color: #0f4c81;
                background: #f8f9fa;
            }

            .file-option input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            .file-option label {
                cursor: pointer;
                flex: 1;
            }

            .file-size {
                color: #666;
                font-size: 0.85rem;
            }

            .loaded-files-list {
                margin-top: 1rem;
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 4px;
                min-height: 50px;
            }

            .loaded-files-list h4 {
                color: #0f4c81;
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            .loaded-files-list ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .loaded-files-list li {
                padding: 0.25rem 0;
                font-size: 0.85rem;
                color: #666;
            }

            .loaded-files-list .empty-state {
                color: #999;
                font-style: italic;
                font-size: 0.85rem;
            }

            footer {
                text-align: center;
                padding: 2rem;
                color: #666;
                background: white;
                margin-top: 3rem;
            }

            footer a {
                color: #0f4c81;
                text-decoration: none;
            }

            .tabs {
                background: white;
                padding: 0;
                border-radius: 8px 8px 0 0;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 0;
                display: flex;
                overflow: hidden;
            }

            .tab-button {
                flex: 1;
                padding: 1rem 1.5rem;
                background: #f5f5f5;
                border: none;
                border-bottom: 3px solid transparent;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 500;
                color: #666;
                transition: all 0.3s;
            }

            .tab-button:hover {
                background: #e8f4f8;
                color: #0f4c81;
            }

            .tab-button.active {
                background: white;
                color: #0f4c81;
                border-bottom-color: #0f4c81;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .lookup-box {
                background: white;
                padding: 1.5rem;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 1rem;
            }

            .lookup-box h2 {
                color: #0f4c81;
                margin-bottom: 1rem;
            }

            .input-group {
                display: flex;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .input-group input {
                flex: 2;
                padding: 0.75rem;
                border: 2px solid #ddd;
                border-radius: 4px;
                font-size: 1rem;
            }

            .input-group input:focus {
                outline: none;
                border-color: #0f4c81;
            }

            .input-group select {
                flex: 0 0 auto;
                min-width: 120px;
                padding: 0.75rem;
                border: 2px solid #ddd;
                border-radius: 4px;
                font-size: 1rem;
                background: white;
                cursor: pointer;
            }

            .input-group select:focus {
                outline: none;
                border-color: #0f4c81;
            }

            .lookup-info {
                background: #f8f9fa;
                padding: 1rem;
                border-radius: 4px;
                margin-bottom: 1rem;
                font-size: 0.9rem;
                color: #666;
            }

            .entity-section {
                margin-bottom: 1.5rem;
            }

            .entity-section h4 {
                color: #0f4c81;
                margin-bottom: 0.5rem;
                font-size: 1rem;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Interactive SQL Query Interface</h1>
            <p>
                Query taxpayer records (2013-2018) directly in your browser using
                DuckDB-WASM
            </p>
        </header>

        <div class="container">
            <div class="left-panel">
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab('lookup')">NTN/CNIC Lookup</button>
                    <button class="tab-button" onclick="switchTab('sql')">SQL Query</button>
                </div>

                <div id="lookup-tab" class="tab-content active">
                    <div class="lookup-box">
                        <h2>NTN/CNIC Lookup</h2>
                        <div class="button-group" style="margin-bottom: 1rem">
                            <span id="status-lookup" class="status loading"
                                >Initializing database...</span
                            >
                        </div>
                        <div class="lookup-info">
                            Enter an NTN (7 digits) or CNIC (13 digits) to search across all years (2013-2018) and entity types. NTN searches match on the first 7 digits to find records even if the 8th digit changed. Uses HTTP range requests to query remote files without downloading them entirely.
                        </div>
                        <div class="input-group">
                            <select id="idType">
                                <option value="auto">Auto-detect</option>
                                <option value="ntn">NTN</option>
                                <option value="cnic">CNIC</option>
                            </select>
                            <input
                                type="text"
                                id="idInput"
                                placeholder="Enter NTN (7 digits) or CNIC (13 digits)"
                                onkeypress="if(event.key === 'Enter') lookupId()"
                            />
                            <button class="primary" onclick="lookupId()" id="lookupBtn" disabled>
                                Lookup
                            </button>
                        </div>
                    </div>
                </div>

                <div id="sql-tab" class="tab-content">
                    <div class="file-selector">
                        <h3>Select Parquet Files to Load</h3>
                        <div class="file-options">
                            <div class="file-option">
                                <input
                                    type="checkbox"
                                    id="file-companies"
                                    checked
                                    onchange="updateLoadButton()"
                                />
                                <label for="file-companies" style="flex: 0 0 auto; min-width: 100px;">
                                    <div>Companies</div>
                                </label>
                                <select id="year-companies" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="2018">2018</option>
                                    <option value="2017">2017</option>
                                    <option value="2016">2016</option>
                                    <option value="2015">2015</option>
                                    <option value="2014">2014</option>
                                    <option value="2013">2013</option>
                                </select>
                            </div>
                            <div class="file-option">
                                <input
                                    type="checkbox"
                                    id="file-aop"
                                    checked
                                    onchange="updateLoadButton()"
                                />
                                <label for="file-aop" style="flex: 0 0 auto; min-width: 100px;">
                                    <div>AOP</div>
                                </label>
                                <select id="year-aop" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="2018">2018</option>
                                    <option value="2017">2017</option>
                                    <option value="2016">2016</option>
                                    <option value="2015">2015</option>
                                    <option value="2014">2014</option>
                                    <option value="2013">2013</option>
                                </select>
                            </div>
                            <div class="file-option">
                                <input
                                    type="checkbox"
                                    id="file-individuals"
                                    checked
                                    onchange="updateLoadButton()"
                                />
                                <label for="file-individuals" style="flex: 0 0 auto; min-width: 100px;">
                                    <div>Individuals</div>
                                </label>
                                <select id="year-individuals" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="2018">2018</option>
                                    <option value="2017">2017</option>
                                    <option value="2016">2016</option>
                                    <option value="2015">2015</option>
                                    <option value="2014">2014</option>
                                    <option value="2013">2013</option>
                                </select>
                            </div>
                        </div>
                        <button
                            class="primary"
                            onclick="loadSelectedFiles()"
                            id="loadBtn"
                        >
                            Load Selected Files
                        </button>
                        <div class="loaded-files-list">
                            <h4>Loaded Tables</h4>
                            <div id="loadedFilesList" class="empty-state">No files loaded yet</div>
                        </div>
                    </div>

                    <div class="query-box">
                        <h2>SQL Query</h2>
                        <div class="button-group" style="margin-bottom: 1rem">
                            <span id="status" class="status loading"
                                >Initializing database...</span
                            >
                        </div>
                        <textarea
                            id="sqlQuery"
                            placeholder="Enter your SQL query here..."
                        >
SELECT * FROM companies_2018 ORDER BY tax_paid DESC LIMIT 10</textarea
                        >
                        <div class="button-group">
                            <button
                                class="primary"
                                onclick="runQuery()"
                                id="runBtn"
                                disabled
                            >
                                Run Query
                            </button>
                            <button class="secondary" onclick="clearResults()">
                                Clear Results
                            </button>
                        </div>
                    </div>

                    <div class="examples">
                        <h3>Example Queries (click to load)</h3>
                        <div class="example-query" onclick="loadExample(this)">
                            SELECT * FROM companies_2018 ORDER BY tax_paid DESC LIMIT 10
                        </div>
                        <div class="example-query" onclick="loadExample(this)">
                            SELECT * FROM aop_2018 ORDER BY tax_paid DESC LIMIT 10
                        </div>
                        <div class="example-query" onclick="loadExample(this)">
                            SELECT * FROM individuals_2018 ORDER BY tax_paid DESC LIMIT 10
                        </div>
                        <div class="example-query" onclick="loadExample(this)">
                            SELECT COUNT(*), SUM(tax_paid) as total_tax FROM companies_2018
                            WHERE tax_paid > 0
                        </div>
                        <div class="example-query" onclick="loadExample(this)">
                            SELECT * FROM companies_2018 WHERE name LIKE '%BANK%' ORDER BY
                            tax_paid DESC LIMIT 20
                        </div>
                        <div class="example-query" onclick="loadExample(this)">
                            SELECT * FROM individuals_2018 WHERE name LIKE '%MUHAMMAD%' ORDER
                            BY tax_paid DESC LIMIT 20
                        </div>
                        <div class="example-query" onclick="loadExample(this)">
                            SELECT * FROM companies_2013
                            UNION ALL SELECT * FROM companies_2014
                            ORDER BY tax_paid DESC LIMIT 20
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="results" id="results">
                    <h3>Results</h3>
                    <div class="results-info" id="resultsInfo"></div>
                    <div id="resultsTable">
                        <p style="color: #666; padding: 2rem; text-align: center;">Run a query to see results</p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p><a href="index.html">‚Üê Back to Overview</a></p>
            <p style="margin-top: 1rem">
                <strong>Data Source:</strong>
                <a
                    href="https://fbr.gov.pk/Categ/income-tax-directory/742"
                    target="_blank"
                >
                    FBR Income Tax Directory
                </a>
            </p>
            <p style="margin-top: 0.5rem">Powered by DuckDB-WASM</p>
        </footer>

        <script type="module">
            import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm";

            let db;
            let conn;
            const loadedFiles = new Set();

            async function initDB() {
                const status = document.getElementById("status");
                const statusLookup = document.getElementById("status-lookup");

                try {
                    status.textContent = "Loading DuckDB-WASM...";
                    statusLookup.textContent = "Loading DuckDB-WASM...";

                    const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                    const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
                    const worker_url = URL.createObjectURL(
                        new Blob([`importScripts("${bundle.mainWorker}");`], {
                            type: "text/javascript",
                        }),
                    );
                    const worker = new Worker(worker_url);
                    const logger = new duckdb.ConsoleLogger();
                    db = new duckdb.AsyncDuckDB(logger, worker);
                    await db.instantiate(bundle.mainModule);
                    URL.revokeObjectURL(worker_url);

                    conn = await db.connect();

                    status.textContent = "Database ready";
                    status.className = "status ready";
                    statusLookup.textContent = "Database ready";
                    statusLookup.className = "status ready";
                    document.getElementById("lookupBtn").disabled = false;
                } catch (error) {
                    status.textContent = "Error initializing database";
                    status.className = "status error";
                    statusLookup.textContent = "Error initializing database";
                    statusLookup.className = "status error";
                    console.error("Error initializing DuckDB:", error);
                    document.getElementById("results").innerHTML =
                        `<div class="error">Error: ${error.message}</div>`;
                    document.getElementById("results").classList.add("visible");
                }
            }

            window.loadSelectedFiles = async function () {
                const status = document.getElementById("status");
                const runBtn = document.getElementById("runBtn");
                const loadBtn = document.getElementById("loadBtn");

                const yearCompanies = document.getElementById("year-companies").value;
                const yearAop = document.getElementById("year-aop").value;
                const yearIndividuals = document.getElementById("year-individuals").value;

                const files = {
                    companies: {
                        checkbox: document.getElementById("file-companies"),
                        year: yearCompanies,
                        filename: `data/${yearCompanies}/companies.parquet`,
                        table: `companies_${yearCompanies}`,
                        displayName: `Companies (${yearCompanies})`,
                    },
                    aop: {
                        checkbox: document.getElementById("file-aop"),
                        year: yearAop,
                        filename: `data/${yearAop}/aop.parquet`,
                        table: `aop_${yearAop}`,
                        displayName: `AOP (${yearAop})`,
                    },
                    individuals: {
                        checkbox: document.getElementById("file-individuals"),
                        year: yearIndividuals,
                        filename: `data/${yearIndividuals}/individuals.parquet`,
                        table: `individuals_${yearIndividuals}`,
                        displayName: `Individuals (${yearIndividuals})`,
                    },
                };

                loadBtn.disabled = true;

                try {
                    for (const [key, file] of Object.entries(files)) {
                        const fileKey = `${key}_${file.year}`;
                        if (file.checkbox.checked && !loadedFiles.has(fileKey)) {
                            status.textContent = `Downloading ${file.filename}...`;

                            const resp = await fetch(file.filename);
                            const buffer = await resp.arrayBuffer();
                            await db.registerFileBuffer(
                                file.filename,
                                new Uint8Array(buffer),
                            );

                            status.textContent = `Creating ${file.table} table...`;
                            await conn.query(
                                `CREATE TABLE IF NOT EXISTS ${file.table} AS SELECT * FROM read_parquet('${file.filename}')`,
                            );

                            loadedFiles.add(fileKey);
                        }
                    }

                    updateLoadedFilesList();
                    status.textContent = `Ready to query! (${loadedFiles.size} tables loaded)`;
                    status.className = "status ready";
                    runBtn.disabled = false;
                } catch (error) {
                    status.textContent = "Error loading files";
                    status.className = "status error";
                    console.error("Error loading files:", error);
                    alert(`Error loading files: ${error.message}`);
                } finally {
                    loadBtn.disabled = false;
                }
            };

            function updateLoadedFilesList() {
                const listContainer = document.getElementById("loadedFilesList");
                if (loadedFiles.size === 0) {
                    listContainer.className = "empty-state";
                    listContainer.innerHTML = "No files loaded yet";
                } else {
                    listContainer.className = "";
                    const items = Array.from(loadedFiles).map(fileKey => {
                        const [type, year] = fileKey.split('_');
                        const displayName = type.charAt(0).toUpperCase() + type.slice(1);
                        return `<li>${displayName} (${year})</li>`;
                    }).join('');
                    listContainer.innerHTML = `<ul>${items}</ul>`;
                }
            }

            window.updateLoadButton = function () {
                const loadBtn = document.getElementById("loadBtn");
                const anyChecked =
                    document.getElementById("file-companies").checked ||
                    document.getElementById("file-aop").checked ||
                    document.getElementById("file-individuals").checked;
                loadBtn.disabled = !anyChecked;
            };

            window.runQuery = async function () {
                const query = document.getElementById("sqlQuery").value.trim();
                if (!query || !conn) return;

                const resultsInfo = document.getElementById("resultsInfo");
                const resultsTable = document.getElementById("resultsTable");

                resultsTable.innerHTML =
                    '<div class="loading">Executing query...</div>';
                resultsInfo.textContent = "";

                try {
                    const startTime = performance.now();
                    const result = await conn.query(query);
                    const endTime = performance.now();
                    const rows = result.toArray();

                    resultsInfo.textContent = `${rows.length} rows returned in ${(endTime - startTime).toFixed(2)}ms`;

                    if (rows.length === 0) {
                        resultsTable.innerHTML = "<p>No results found.</p>";
                        return;
                    }

                    const columns = result.schema.fields.map((f) => f.name);

                    let html = "<table><thead><tr>";
                    columns.forEach((col) => {
                        html += `<th>${col}</th>`;
                    });
                    html += "</tr></thead><tbody>";

                    rows.forEach((row) => {
                        html += "<tr>";
                        columns.forEach((col) => {
                            const value = row[col];
                            html += `<td>${value !== null ? value : ""}</td>`;
                        });
                        html += "</tr>";
                    });

                    html += "</tbody></table>";
                    resultsTable.innerHTML = html;
                } catch (error) {
                    resultsTable.innerHTML = `<div class="error">Query Error: ${error.message}</div>`;
                }
            };

            window.loadExample = function (element) {
                document.getElementById("sqlQuery").value = element.textContent;
            };

            window.clearResults = function () {
                document.getElementById("resultsInfo").textContent = "";
                document.getElementById("resultsTable").innerHTML =
                    '<p style="color: #666; padding: 2rem; text-align: center;">Run a query to see results</p>';
            };

            window.switchTab = function (tabName) {
                const tabs = document.querySelectorAll('.tab-button');
                const contents = document.querySelectorAll('.tab-content');

                tabs.forEach(tab => tab.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));

                event.target.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            };

            window.lookupId = async function () {
                const idValue = document.getElementById("idInput").value.trim();
                const idType = document.getElementById("idType").value;
                if (!idValue || !conn) return;

                const resultsInfo = document.getElementById("resultsInfo");
                const resultsTable = document.getElementById("resultsTable");

                resultsTable.innerHTML = '<div class="loading">Searching across all files...</div>';
                resultsInfo.textContent = "";

                try {
                    const startTime = performance.now();
                    const baseUrl = 'https://old.hashirsafdar.com/pakistan-taxpayer/data';
                    const years = [2018, 2017, 2016, 2015, 2014, 2013];

                    let detectedType = idType;
                    if (idType === 'auto') {
                        detectedType = idValue.length === 13 ? 'cnic' : 'ntn';
                    }

                    let queries = [];

                    if (detectedType === 'ntn' || detectedType === 'auto') {
                        const searchNtn7 = idValue.substring(0, 7).padStart(7, '0');
                        const ntn7Int = parseInt(searchNtn7);
                        const ntn7Next = String(ntn7Int + 1).padStart(7, '0');
                        const ntn8Min = searchNtn7 + '0';
                        const ntn8Max = ntn7Next + '0';

                        for (const year of years) {
                            if (year >= 2017) {
                                queries.push(`
                                    SELECT ${year} as year, 'Company' as entity_type, name, ntn_7 as id, tax_paid
                                    FROM '${baseUrl}/${year}/companies.parquet'
                                    WHERE ntn_7 = '${searchNtn7}'
                                `);

                                queries.push(`
                                    SELECT ${year} as year, 'AOP' as entity_type, name, ntn_7 as id, tax_paid
                                    FROM '${baseUrl}/${year}/aop.parquet'
                                    WHERE ntn_7 = '${searchNtn7}'
                                `);
                            } else {
                                queries.push(`
                                    SELECT ${year} as year, 'Company' as entity_type, name, ntn_8 as id, tax_paid
                                    FROM '${baseUrl}/${year}/companies.parquet'
                                    WHERE ntn_8 >= '${ntn8Min}' AND ntn_8 < '${ntn8Max}'
                                `);

                                queries.push(`
                                    SELECT ${year} as year, 'AOP' as entity_type, name, ntn_8 as id, tax_paid
                                    FROM '${baseUrl}/${year}/aop.parquet'
                                    WHERE ntn_8 >= '${ntn8Min}' AND ntn_8 < '${ntn8Max}'
                                `);

                                if (year === 2013) {
                                    queries.push(`
                                        SELECT ${year} as year, 'Individual' as entity_type, name, ntn_8 as id, tax_paid
                                        FROM '${baseUrl}/${year}/individuals.parquet'
                                        WHERE ntn_8 >= '${ntn8Min}' AND ntn_8 < '${ntn8Max}'
                                    `);
                                }
                            }
                        }
                    }

                    if (detectedType === 'cnic' || detectedType === 'auto') {
                        const paddedCnic = idValue.padStart(13, '0');
                        for (const year of years) {
                            if (year !== 2013) {
                                queries.push(`
                                    SELECT ${year} as year, 'Individual' as entity_type, name, cnic as id, tax_paid
                                    FROM '${baseUrl}/${year}/individuals.parquet'
                                    WHERE cnic = '${paddedCnic}'
                                `);
                            }
                        }
                    }

                    const fullQuery = queries.join(' UNION ALL ') + ' ORDER BY year DESC, entity_type';

                    const result = await conn.query(fullQuery);
                    const endTime = performance.now();
                    const rows = result.toArray();

                    resultsInfo.textContent = `${rows.length} record(s) found in ${(endTime - startTime).toFixed(2)}ms`;

                    if (rows.length === 0) {
                        resultsTable.innerHTML = "<p>No records found for this NTN/CNIC.</p>";
                        return;
                    }

                    let html = '<div>';

                    const groupedByEntity = {};
                    rows.forEach(row => {
                        if (!groupedByEntity[row.entity_type]) {
                            groupedByEntity[row.entity_type] = [];
                        }
                        groupedByEntity[row.entity_type].push(row);
                    });

                    for (const [entityType, records] of Object.entries(groupedByEntity)) {
                        html += `<div class="entity-section">`;
                        html += `<h4>${entityType} Records</h4>`;
                        html += `<table><thead><tr><th>Year</th><th>Name</th><th>ID</th><th>Tax Paid</th></tr></thead><tbody>`;

                        records.forEach(row => {
                            html += `<tr>`;
                            html += `<td>${row.year}</td>`;
                            html += `<td>${row.name}</td>`;
                            html += `<td>${row.id}</td>`;
                            html += `<td>${row.tax_paid.toLocaleString()}</td>`;
                            html += `</tr>`;
                        });

                        html += `</tbody></table></div>`;
                    }

                    html += '</div>';
                    resultsTable.innerHTML = html;
                } catch (error) {
                    resultsTable.innerHTML = `<div class="error">Lookup Error: ${error.message}</div>`;
                }
            };

            initDB();
        </script>
    </body>
</html>
